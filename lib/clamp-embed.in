#!/bin/bash

# check command line arguments
if [ "$#" -ne 2 ]; then
  echo "Usage: $0 input_object output_kernel" >&2
  exit 1
fi

if [ ! -f $1 ]; then
  echo "input object $1 is not valid" >&2
  exit 1
fi

if [[ $OSTYPE == linux-gnu ]]; then
  objcopy -B i386:x86-64 -I binary -O elf64-x86-64 --rename-section .data=.kernel $1 $2
elif [[ $OSTYPE == darwin* ]]; then
# OS X
  touch $2.stub.c
  gcc -o $2.stub.o -c $2.stub.c
  ld -r -o $2 -sectcreate binary kernel_cl $1 $2.stub.o
  rm -f $2.stub.c $2.stub.o
fi
